name: Build, Upload APK and Send Email

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    env:
      PATH: $HOME/.local/bin:$PATH   # pour que rclone install√© localement soit trouv√©

    steps:
      # 1Ô∏è‚É£ Installer tar et unzip (au cas o√π)
      - name: Ensure tar and unzip are installed
        run: sudo apt-get update && sudo apt-get install -y tar unzip curl

      # 2Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Evite extraction d'archive si tar manquant

      # 3Ô∏è‚É£ Setup Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 4Ô∏è‚É£ Installer d√©pendances npm
      - name: Install dependencies
        run: npm install

      # 5Ô∏è‚É£ Setup Java
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 6Ô∏è‚É£ Grant execute permission for gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      # 7Ô∏è‚É£ Build Release APK
      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease

      # 8Ô∏è‚É£ Upload APK comme artifact GitHub
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: android/app/build/outputs/apk/release/app-release.apk

      # 9Ô∏è‚É£ Installer rclone localement
      - name: Install rclone locally
        run: |
          curl -O https://downloads.rclone.org/v1.72.1/rclone-v1.72.1-linux-amd64.zip
          unzip rclone-v1.72.1-linux-amd64.zip
          cp rclone-v1.72.1-linux-amd64/rclone ~/.local/bin/
          chmod +x ~/.local/bin/rclone

      # üîü Ajouter rclone config depuis secret
      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload APK vers OneDrive et obtenir lien partageable
      - name: Upload APK to OneDrive
        run: |
          rclone copy android/app/build/outputs/apk/release/app-release.apk onedrive2:ApkUploads -v
          LINK=$(rclone link onedrive2:ApkUploads/app-release.apk)
          echo "APK_LINK=$LINK" >> $GITHUB_ENV

      # 1Ô∏è‚É£2Ô∏è‚É£ Envoyer email avec le lien OneDrive
      - name: Send email with APK link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          from: ${{ secrets.GMAIL_USERNAME }}
          subject: "Nouvel APK Build Release"
          body: |
            Bonjour,

            L'APK de l'application a √©t√© g√©n√©r√©.  
            Vous pouvez le t√©l√©charger ici (OneDrive) : ${{ env.APK_LINK }}

            Cordialement.
          to: "wkhlaifi@smartech-tn.com"
