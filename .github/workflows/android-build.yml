name: Build, Upload APK and Send Email

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    env:
      PATH: $HOME/.local/bin:$PATH

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: android/app/build/outputs/apk/release/app-release.apk

      # Installer tar et unzip avant rclone
      - name: Install tar and unzip
        run: sudo apt-get update && sudo apt-get install -y tar unzip

      - name: Install rclone locally
        run: |
          curl -O https://downloads.rclone.org/v1.72.1/rclone-v1.72.1-linux-amd64.zip
          unzip rclone-v1.72.1-linux-amd64.zip
          mkdir -p ~/.local/bin
          cp rclone-v1.72.1-linux-amd64/rclone ~/.local/bin/
          chmod +x ~/.local/bin/rclone
          rclone version

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Upload APK to OneDrive
        run: |
          rclone copy android/app/build/outputs/apk/release/app-release.apk onedrive2:ApkUploads -v
          LINK=$(rclone link onedrive2:ApkUploads/app-release.apk)
          echo "APK_LINK=$LINK" >> $GITHUB_ENV

      - name: Send email with APK link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          from: ${{ secrets.GMAIL_USERNAME }}
          subject: "Nouvel APK Build Release"
          body: |
            Bonjour,

            L'APK de l'application a été généré.  
            Vous pouvez le télécharger ici (OneDrive) : ${{ env.APK_LINK }}

            Cordialement.
          to: "wkhlaifi@smartech-tn.com"
